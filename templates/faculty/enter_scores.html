{% extends "base.html" %}

{% block title %}Enter Scores - {{ assessment.assessment_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('faculty_dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('faculty_assessments', course_id=course.course_id) }}">Assessments</a></li>
            <li class="breadcrumb-item active">Enter Scores</li>
        </ol>
    </nav>

    <!-- Assessment Info -->
    <div class="card mb-4" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(234, 88, 12, 0.15)); border: none;">
        <div class="card-body">
            <h3 class="mb-2">{{ assessment.assessment_name }}</h3>
            <p class="text-muted mb-0">
                <span class="badge bg-warning me-2">{{ assessment.assessment_type|title }}</span>
                {{ course.course_name }} ({{ course.course_code }}) | Max Marks: {{ assessment.max_marks }}
            </p>
        </div>
    </div>

    <!-- Enter Scores Form -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-pencil-square"></i> Enter Student Scores</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('save_scores', assessment_id=assessment.assessment_id) }}">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Student Name</th>
                                <th>Marks Obtained (Max: {{ assessment.max_marks }})</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if students %}
                                {% for student in students %}
                                <tr>
                                    <td>{{ student.username }}</td>
                                    <td>{{ student.full_name }}</td>
                                    <td>
                                        <input type="number" 
                                               class="form-control" 
                                               name="scores[{{ student.user_id }}]" 
                                               min="0" 
                                               max="{{ assessment.max_marks }}" 
                                               step="0.5"
                                               value="{{ student.current_score or '' }}"
                                               data-max="{{ assessment.max_marks }}"
                                               onchange="calculatePercentage(this)">
                                    </td>
                                    <td>
                                        <span class="percentage-display badge bg-secondary">-</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-5">
                                        No students enrolled in this course
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                {% if students %}
                <div class="mt-4">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle"></i> Save All Scores
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-lg" onclick="calculateAttainment()">
                        <i class="bi bi-calculator"></i> Calculate CLO Attainment
                    </button>
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
function calculatePercentage(input) {
    const maxMarks = parseFloat(input.getAttribute('data-max'));
    const obtained = parseFloat(input.value) || 0;
    const percentage = (obtained / maxMarks * 100).toFixed(2);
    
    const row = input.closest('tr');
    const badge = row.querySelector('.percentage-display');
    badge.textContent = percentage + '%';
    
    // Color coding
    if (percentage >= 75) {
        badge.className = 'percentage-display badge bg-success';
    } else if (percentage >= 60) {
        badge.className = 'percentage-display badge bg-primary';
    } else if (percentage >= 50) {
        badge.className = 'percentage-display badge bg-warning';
    } else {
        badge.className = 'percentage-display badge bg-danger';
    }
}

// Calculate percentages on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[name^="scores"]').forEach(input => {
        if (input.value) {
            calculatePercentage(input);
        }
    });
});

function calculateAttainment() {
    // Trigger backend calculation
    fetch(`/api/calculate-attainment/{{ assessment.assessment_id }}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('CLO attainment calculated successfully!', 'success');
        }
    })
    .catch(error => showToast('Error calculating attainment', 'danger'));
}
</script>
{% endblock %}
{% endblock %}
